<!DOCTYPE html>

<html data-theme="dark" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Secure File Sharing ‚Äî Access</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&amp;display=swap" rel="stylesheet"/>
<script async="" defer="" src="https://www.google.com/recaptcha/api.js"></script>
<style>
  /* Improve text crispness and avoid heavy backdrop blur */
html, body {
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  text-rendering: optimizeLegibility;
}

/* Make elements render more crisply */
.panel, .panel * {
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  text-rendering: optimizeLegibility;
  backface-visibility: hidden;
  -webkit-backface-visibility: hidden;
}

/* Reduce the heavy backdrop blur that makes nearby text look soft */
.panel {
  /* if you want it even crisper, set to 'none' or lower value */
  backdrop-filter: blur(6px) !important;
}

    :root{
      --bg:#05060a;
      --glass: rgba(255,255,255,0.03);
      --card:#0f1220;
      --muted:#9aa3bd;
      --text:#eef2ff;
      --primary:#7aa2ff;
      --accent:#1be7c9;
      --rose:#ff77e1;
      --success:#2ecc71;
      --danger:#ff6b6b;
      --radius:18px;
      --shadow: 0 20px 60px rgba(2,6,23,0.7);
    }
    *{box-sizing:border-box}
    html,body{height:100%; margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; color:var(--text); background: radial-gradient(800px 500px at 10% 10%, rgba(122,162,255,0.06), transparent), radial-gradient(600px 420px at 95% 10%, rgba(27,231,201,0.04), transparent),var(--bg); -webkit-font-smoothing:antialiased;}
    /* animated orbs */
    .orb{ position:fixed; filter:blur(80px); opacity:.6; pointer-events:none; z-index:0; mix-blend-mode:screen; }
    .orb.o1{ width:640px; height:640px; left:-220px; top:-200px; background: radial-gradient(circle at 30% 30%, var(--primary), transparent 60%); animation: float1 13s ease-in-out infinite; }
    .orb.o2{ width:540px; height:540px; right:-180px; top:-120px; background: radial-gradient(circle at 60% 40%, var(--rose), transparent 60%); animation: float2 14s ease-in-out infinite; }
    .orb.o3{ width:480px; height:480px; left:8%; bottom:-160px; background: radial-gradient(circle at 40% 60%, var(--accent), transparent 60%); animation: float3 16s ease-in-out infinite; }
    @keyframes float1{0%,100%{transform:translateY(0)}50%{transform:translateY(30px)}}
    @keyframes float2{0%,100%{transform:translateY(0)}50%{transform:translateY(-40px)}}
    @keyframes float3{0%,100%{transform:translateX(0)}50%{transform:translateX(40px)}}

    /* center stage */
    .wrap{position:relative; z-index:1; min-height:100vh; display:grid; place-items:center; padding:32px;}
    .stage{ width:min(1100px,96vw); }
    .card{ border-radius:var(--radius); overflow:hidden; box-shadow:var(--shadow); border:1px solid rgba(255,255,255,0.04); background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent); display:block; transform-style:preserve-3d; transition: transform .9s cubic-bezier(.2,.8,.2,1); }
    @media (max-width:980px){ .card{ grid-template-columns: 1fr; } }

    /* left visual */
    .left{
      padding:36px; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); display:flex; flex-direction:column; gap:18px; justify-content:space-between;
      border-right:1px solid rgba(255,255,255,0.03);
    }
    .logo{ width:56px; height:56px; border-radius:14px; background:conic-gradient(from 120deg,var(--primary),var(--accent),var(--rose)); box-shadow:0 8px 26px rgba(122,162,255,0.18), inset 0 0 10px rgba(255,255,255,0.06); }
    .brand{ display:flex; gap:14px; align-items:center; }
    h1{ font-size:24px; margin:0; letter-spacing:.2px; }
    p.lead{ margin:0; color:var(--muted); }
    .badges{ display:flex; gap:10px; flex-wrap:wrap; margin-top:6px; }
    .badge{ background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:8px 12px; border-radius:12px; border:1px solid rgba(255,255,255,0.03); font-size:13px; color:#dfe7ff; }

    /* right form area (flip container) */
    .flip-scene{ perspective:1400px; display:flex; align-items:center; justify-content:center; padding:36px; }
    .flip-card{ width:520px; transform-style:preserve-3d; transition: transform .9s cubic-bezier(.2,.8,.2,1); }
    .flip-card.flipped{ transform: rotateY(180deg); }
    .panel{ position:relative; width:100%; min-height:440px; border-radius:12px; background: linear-gradient(180deg, rgba(18,22,40,0.78), rgba(14,18,34,0.78)); border:1px solid rgba(255,255,255,0.035); padding:28px; box-shadow: 0 20px 50px rgba(2,6,23,0.6); backface-visibility:hidden; display:flex; flex-direction:column; justify-content:center; gap:12px; }
    .panel.back{ transform: rotateY(180deg); position:absolute; inset:0; }
    @media (max-width:980px){ .flip-card{ width:92vw } }

    label{ display:block; font-size:13px; color:var(--muted); margin-bottom:6px; }
    .field{ position:relative; margin-bottom:12px; }
    input[type="text"], input[type="password"], input[type="file"]{ width:100%; padding:14px 44px 14px 44px; border-radius:12px; border:1px solid rgba(255,255,255,0.14); background:#10162e; color:var(--text); outline:none; transition: box-shadow .18s, transform .06s, border-color .12s; }
    input:focus{ box-shadow: 0 8px 30px rgba(122,162,255,0.08); border-color: rgba(122,162,255,0.6); transform:translateY(-1px); }

    .icon{ position:absolute; left:12px; top:50%; transform:translateY(-50%); width:20px; height:20px; opacity:.9; }
    .actions{ display:flex; gap:12px; margin-top:12px; align-items:center; }
    .btn{ padding:12px 16px; border-radius:12px; border:0; cursor:pointer; font-weight:700; letter-spacing:.2px; background:linear-gradient(135deg,var(--primary),#5a7bff); color:white; box-shadow: 0 12px 28px rgba(90,123,255,0.2); transition: transform .08s ease, filter .12s; }
    .btn:active{ transform:translateY(1px) }
    .btn.ghost{ background:transparent; border:1px dashed rgba(255,255,255,0.06); color:var(--text); box-shadow:none; }

    .small{ font-size:13px; color:var(--muted) }

    /* file list & log styling (kept from original but prettier) */
    .panel .block{ margin-top:10px; padding-top:12px; border-top:1px dashed rgba(255,255,255,0.03); }
    .file-item{ display:flex; justify-content:space-between; align-items:center; gap:10px; padding:10px; background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0)); border-radius:12px; margin-bottom:8px; border:1px solid rgba(255,255,255,0.03); }
    .log-entry{ padding:12px; border-radius:10px; background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0)); border-left:4px solid var(--primary); margin-bottom:10px; color:#e9f0ff; }

    /* toast */
    .toast{ position:fixed; right:22px; bottom:22px; background:linear-gradient(135deg,#11162b,#0a1230); border:1px solid rgba(255,255,255,0.04); padding:12px 16px; border-radius:12px; display:none; z-index:5; color:var(--text) }

    /* micro interactions */
    .tilt{ transition: transform .25s ease; will-change: transform; }
    .help-link{ color:var(--accent); text-decoration:none; }

    /* responsive tweaks */
    @media (max-width:980px){
      .left{ padding:20px; }
      .flip-scene{ padding:20px; }
    }
  
.small a{ color:var(--accent); text-decoration:none; }
.small a:hover{ text-decoration:underline; }

/* Navbar */
.navbar{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:12px 16px;
  border-radius:12px; background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
  border:1px solid rgba(255,255,255,.05); margin-bottom:12px}
.nav-left{display:flex; align-items:center; gap:10px}
.nav-user{font-weight:700}
.nav-actions{display:flex; align-items:center; gap:10px}

/* Two-column app layout */
.app-grid{display:grid; grid-template-columns: 1fr 1fr; gap:16px; margin-top:6px}
@media (max-width: 980px){ .app-grid{ grid-template-columns: 1fr; } }

.card-lite{padding:12px; border-radius:12px; background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0));
  border:1px solid rgba(255,255,255,.04)}
.section-title{margin:0 0 8px 0; font-weight:700}

/* Footer log */
.footer-log{margin-top:16px}

/* Auth mode: full-width layout, no left branding */
body.auth .left{ display:none !important; }
body.auth .card{ display:block; }
body.auth .stage{ width:min(1280px, 96vw); }
body.auth .flip-scene{ padding:0; }
body.auth .flip-card{ width:100%; }
body.auth .panel.front{ display:none !important; }
body.auth .panel.back{ position:static; inset:auto; transform:none; min-height:auto; }


/* FORCE auth mode visuals */
body.auth .left{ display:none !important; opacity:0 !important; width:0 !important; margin:0 !important; padding:0 !important; }
body.auth .card{ display:block !important; width:100% !important; box-shadow:none !important; border-radius:12px; }
body.auth .stage{ width:100% !important; max-width:1400px; }
body.auth .flip-scene{ padding:0 !important; }
body.auth .flip-card{ width:100% !important; transform:none !important; }
body.auth .panel.front{ display:none !important; }
body.auth .panel.back{
  position:relative !important; inset:auto !important; transform:none !important; min-height:400px !important;
  display:block !important; padding:20px !important;
}
/* ensure mainPanel is full width */
#mainPanel{ width:100%; display:block; }
.app-grid{ grid-template-columns: 1fr 420px; gap:18px; }
@media (max-width:980px){ .app-grid{ grid-template-columns: 1fr; } }
</style>
</head>
<!-- ambient visuals -->
<div class="orb o1"></div>
<div class="orb o2"></div>
<div class="orb o3"></div>
<div class="wrap">
<div class="stage">
<div class="card tilt" id="mainCard">
<div class="left"><div><div class="brand"><div class="logo"></div><div><h1>ICT-654 Secure File Sharing</h1><p class="lead">Zero-trust, end‚Äëto‚Äëend encrypted file sharing.</p></div></div><div class="badges"><div class="badge">üîí AES-256</div><div class="badge">üßæ Audit log</div><div class="badge">üß© S3-compatible</div><div class="badge">‚ö° Fast uploads</div></div></div><div><p class="small">Welcome to Our <a class="help-link" href="#" id="toggleLogin">ICT654 Capstone Project </a></p><p class="small"><button class="btn ghost" id="toggleTheme" style="padding:6px 10px">Group No.-5</button></p></div></div><div class="flip-scene" style="padding:32px;">
<div class="flip-card" id="flipCard">
<!-- FRONT: login -->
<div aria-live="polite" class="panel front" id="loginPanel">
<form onsubmit="return false;">
<label for="username">Username</label>
<div class="field">
<svg class="icon" fill="currentColor" viewbox="0 0 24 24"><path d="M12 12c2.7 0 5-2.3 5-5s-2.3-5-5-5-5 2.3-5 5 2.3 5 5 5Zm0 2c-5 0-9 2.7-9 6v2h18v-2c0-3.3-4-6-9-6Z"></path></svg>
<input autocomplete="username" id="username" placeholder="jane.doe" type="text"/>
</div>
<label for="password">Password</label>
<div class="field">
<svg class="icon" fill="currentColor" viewbox="0 0 24 24"><path d="M17 8h-1V6a4 4 0 0 0-8 0v2H7a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-8a2 2 0 0 0-2-2Zm-6 7.73V17h2v-1.27a2 2 0 1 0-2 0ZM9 8V6a3 3 0 0 1 6 0v2H9Z"></path></svg>
<input autocomplete="current-password" id="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" type="password"/>
</div>
<div class="field captcha" style="justify-content:center">
<div class="g-recaptcha" data-sitekey="6LcZHdYrAAAAALIcNyKNh9xMrc3Uuedw0GsO8c5R"></div>
</div>  
<div class="actions">
<button class="btn" id="loginBtn" type="button">Sign in</button>
<button class="btn ghost" id="goSignup" type="button">Create account</button>
</div>
<div class="block">
<p class="small"><a href="#">Make sure to use right credentials and store them to your wallet to avoid loose access.</a></p>
</div>
</form>
</div>
<!-- BACK: sign up and app panels (keeps upload/files/logchain from original) -->
<div class="panel back" id="fullPanel">
<!-- Signup form on top half -->
<div id="signupView" style="display:block;">
<form onsubmit="return false;">
<label for="regUsername">Username</label>
<div class="field">
<svg class="icon" fill="currentColor" viewbox="0 0 24 24"><path d="M12 12c2.7 0 5-2.3 5-5s-2.3-5-5-5-5 2.3-5 5 2.3 5 5 5Zm0 2c-5 0-9 2.7-9 6v2h18v-2c0-3.3-4-6-9-6Z"></path></svg>
<input autocomplete="username" id="regUsername" placeholder="jane.doe" type="text"/>
</div>
<label for="regPassword">Password</label>
<div class="field">
<svg class="icon" fill="currentColor" viewbox="0 0 24 24"><path d="M17 8h-1V6a4 4 0 0 0-8 0v2H7a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-8a2 2 0 0 0-2-2Zm-6 7.73V17h2v-1.27a2 2 0 1 0-2 0ZM9 8V6a3 3 0 0 1 6 0v2H9Z"></path></svg>
<input autocomplete="new-password" id="regPassword" placeholder="Create a strong password" type="password"/>
</div>
<label for="regConfirm">Confirm password</label>
<div class="field">
<svg class="icon" fill="currentColor" viewbox="0 0 24 24"><path d="M12 17.27 8.55 20 9.4 15.45 6 12.5l4.78-.41L12 8l1.22 4.09L18 12.5l-3.4 2.95.85 4.55Z"></path></svg>
<input autocomplete="new-password" id="regConfirm" placeholder="Retype your password" type="password"/>
</div>
<div class="actions">
<button class="btn" id="signupBtn" type="button">Create account</button>
<button class="btn ghost" id="flipBack" type="button">Back to login</button>
</div>
</form>
</div>
<!-- After login / main panel (keeps original structure) -->
<div id="mainPanel" style="margin-top:18px; display:none;"><div class="navbar"><div class="nav-left"><div class="logo"></div><div>Dashboard</div></div><div class="nav-actions"><span id="navUserLabel">Signed in as: </span><span class="nav-user" id="navUser"></span><button class="btn ghost" onclick="handleLogout()">Logout</button></div></div><div class="app-grid"><div class="card-lite"><h3 class="section-title">üìÅ Your Files</h3><div id="fileList">Loading...</div></div><div class="card-lite"><h3 class="section-title">‚¨ÜÔ∏è Upload File</h3><input id="fileInput" type="file"/><button class="btn" onclick="uploadFile()" style="margin-top:10px">Upload</button></div></div><div class="footer-log card-lite"><h3 class="section-title">üìú Blockchain Audit Log</h3><div id="blockchainLog">Loading...</div></div></div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="toast" id="toastMsg"></div>
<script>
function enterAuthMode(sub){
  try{
    document.body.classList.add('auth');
    const front = document.querySelector('.panel.front');
    if(front) front.style.display='none';
    const flipCard = document.getElementById('flipCard');
    if(flipCard) flipCard.classList.add('flipped');
    const signupView = document.getElementById('signupView');
    if(signupView) signupView.style.display='none';
    const mainPanel = document.getElementById('mainPanel');
    if(mainPanel) mainPanel.style.display='block';
    // set navbar username
    if(sub){
      const nu = document.getElementById('navUser'); if(nu) nu.textContent = sub;
      const lead = document.querySelector('.lead'); if(lead) lead.textContent = 'Signed in as ' + sub;
    }
    try{ loadFiles(); }catch(e){}
    try{ loadBlockchain(); }catch(e){}
  }catch(e){}
}


/* Keep original endpoints and reCAPTCHA key exactly as in the project requirements */
let token = localStorage.getItem("pksToken");
const API_BASE = window.location.origin;

/* micro tilt for the card */
const mainCard = document.getElementById('mainCard');
document.addEventListener('mousemove', (e)=>{
  const r = mainCard.getBoundingClientRect();
  const cx = r.left + r.width/2, cy = r.top + r.height/2;
  const dx = (e.clientX - cx)/r.width, dy = (e.clientY - cy)/r.height;
  mainCard.style.transform = `rotateY(${dx*6}deg) rotateX(${ -dy*6 }deg)`;
});

/* flip logic */
const flipCard = document.getElementById('flipCard');
document.getElementById('goSignup').addEventListener('click', ()=> flipCard.classList.add('flipped'));
document.getElementById('flipBack').addEventListener('click', ()=> flipCard.classList.remove('flipped'));
document.getElementById('toggleLogin').addEventListener('click', (e)=>{ e.preventDefault(); window.scrollTo({top:0,behavior:'smooth'}); flipCard.classList.remove('flipped'); });

/* theme toggle */
document.getElementById('toggleTheme').addEventListener('click', ()=>{
  const cur = document.documentElement.getAttribute('data-theme');
  const next = (cur==='dark') ? 'light' : 'dark';
  document.documentElement.setAttribute('data-theme', next);
  localStorage.setItem('theme', next);
});

/* toast */
function showToast(msg){
  const t = document.getElementById('toastMsg');
  t.textContent = msg;
  t.style.display = 'block';
  setTimeout(()=> t.style.display='none', 3600);
}

/* jwt decoder used in UI */
function decodeJWT(t){
  try{
    const base64 = t.split('.')[1].replace(/-/g,'+').replace(/_/g,'/');
    return JSON.parse(atob(base64));
  }catch(e){ return {}; }
}

/* update UI based on auth */
function updateUI(){
  const isAuth = !!token;
  const mainPanel = document.getElementById('mainPanel');
  const signupView = document.getElementById('signupView');
  const loginPanel = document.getElementById('loginPanel');
  document.getElementById('fileList').innerHTML = isAuth ? 'Loading...' : '';
  document.getElementById('blockchainLog').innerHTML = isAuth ? 'Loading...' : '';
  if(isAuth){
    // show main panel inside back panel
    mainPanel.style.display = 'block';
    signupView.style.display = 'none';
    // hide front login visually by keeping flipped to back (but we can also show welcome)
    flipCard.classList.add('flipped');
    // show username in left brand area (non-critical)
    try{ const sub = decodeJWT(token).sub; if(sub) document.querySelector('.lead').textContent = "Signed in as " + sub; }catch(e){}
    loadFiles(); loadBlockchain();
  }else{
    mainPanel.style.display = 'none';
    signupView.style.display = 'block';
    flipCard.classList.remove('flipped');
  }
}

/* original login handling preserved (endpoints and keys unchanged) */
async function handleLogin(){
  const u = document.getElementById('username').value;
  const p = document.getElementById('password').value;
  const captcha = grecaptcha.getResponse();
  if(!captcha){ showToast('Please complete the CAPTCHA'); return; }
  try{
    const res = await fetch(`${API_BASE}/login`, {
      method:'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ username: u, password: p, recaptcha_token: captcha })
    });
    const data = await res.json();
    if(res.ok){
      token = data.access_token;
      localStorage.setItem('pksToken', token);
      showToast('Login successful');
      try{ const sub = decodeJWT(token).sub; enterAuthMode(sub);}catch(e){ enterAuthMode(); }
      updateUI();
    }else{
      showToast(data.detail || 'Login failed');
      grecaptcha.reset();
    }
  }catch(err){
    showToast('Network error. Check server.');
  }
}

/* original register handling preserved */
async function handleRegister(){
  const u = document.getElementById('regUsername').value;
  const p = document.getElementById('regPassword').value;
  const c = document.getElementById('regConfirm').value;
  if(p !== c){ showToast('Passwords do not match'); return; }
  try{
    const res = await fetch(`${API_BASE}/register`, {
      method:'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ username: u, password: p })
    });
    const data = await res.json();
    showToast(res.ok ? 'Registered successfully' : data.detail || 'Error');
    if(res.ok) setTimeout(()=> flipCard.classList.remove('flipped'), 900);
  }catch(err){
    showToast('Network error. Check server.');
  }
}

/* logout - preserved path */
async function handleLogout() {
  try {
    await fetch(`${API_BASE}/logout`, {
      method: 'POST',
      headers: { Authorization: `Bearer ${token}` }
    });
  } catch (e) {
    console.error("Logout error:", e);
  }

  // Clear token
  localStorage.removeItem('pksToken');
  token = null;

  // Update UI
  updateUI();
  showToast('Logged out');

  // Redirect to home page after a short delay (optional so toast is visible)
  setTimeout(() => {
    window.location.href = 'http://127.0.0.1:8000/ui';
  }, 800); // you can adjust delay (ms) as needed
}


/* upload/download/delete - preserved paths and behaviour */
async function uploadFile(){
  const file = document.getElementById('fileInput').files[0];
  if(!file){ showToast('Pick a file first'); return; }
  const fd = new FormData(); fd.append('file', file);
  try{
    const res = await fetch(`${API_BASE}/upload`, { method:'POST', headers: { Authorization: `Bearer ${token}` }, body: fd });
    const data = await res.json();
    showToast(data.message || 'Uploaded');
    loadFiles(); loadBlockchain();
  }catch(e){ showToast('Upload failed'); }
}

async function downloadFile(name){
  try{
    const res = await fetch(`${API_BASE}/download/${encodeURIComponent(name)}`, { headers: { Authorization: `Bearer ${token}` }});
    if(!res.ok){ showToast('Download failed'); return; }
    const blob = await res.blob();
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = name;
    link.click();
    showToast('Downloaded');
    loadBlockchain();
  }catch(e){ showToast('Download failed'); }
}

async function deleteFile(name){
  try{
    const res = await fetch(`${API_BASE}/delete/${encodeURIComponent(name)}`, { method:'DELETE', headers: { Authorization: `Bearer ${token}` }});
    const data = await res.json();
    showToast(data.message || 'Deleted');
    loadFiles(); loadBlockchain();
  }catch(e){ showToast('Delete failed'); }
}

async function loadFiles(){
  try{
    const res = await fetch(`${API_BASE}/files`, { headers: { Authorization: `Bearer ${token}` }});
    const data = await res.json();
    const list = document.getElementById('fileList'); list.innerHTML = '';
    (data.files || []).forEach(name=>{
      const div = document.createElement('div');
      div.className = 'file-item';
      div.innerHTML = `<label style="display:flex;align-items:center;gap:8px"><input type="checkbox" class="fileCheck" value="${name}" /> <span>${name}</span></label>
        <div style="display:flex;gap:8px"><button class="btn ghost" onclick="downloadFile('${name.replace(/'/g, "\\'")}')">Download</button><button class="btn" style="background:var(--danger);color:white" onclick="deleteFile('${name.replace(/'/g, "\\'")}')">Delete</button></div>`;
      list.appendChild(div);
    });
    const bulk = document.createElement('div'); bulk.style.textAlign='center'; bulk.style.marginTop='10px';
    bulk.innerHTML=`<button class="btn" onclick="downloadSelected()">Download Selected</button> <button class="btn" style="background:var(--danger);color:white" onclick="deleteSelected()">Delete Selected</button>`;
    list.appendChild(bulk);
  }catch(e){ document.getElementById('fileList').textContent = 'Failed to load files'; }
}

function getSelectedFiles(){ return Array.from(document.querySelectorAll('.fileCheck:checked')).map(el=>el.value); }
function downloadSelected(){ const files=getSelectedFiles(); if(files.length===0){showToast('No files selected');return;} files.forEach(f=>downloadFile(f)); }
function deleteSelected(){ const files=getSelectedFiles(); if(files.length===0){showToast('No files selected');return;} if(!confirm('Are you sure?')) return; files.forEach(f=>deleteFile(f)); }

async function loadBlockchain(){
  try{
    const res = await fetch(`${API_BASE}/logchain`);
    const data = await res.json();
    const log = document.getElementById('blockchainLog'); log.innerHTML='';
    (data.slice(-12).reverse()||[]).forEach(b=>{
      const div = document.createElement('div');
      div.className = 'log-entry';
      const time = b.timestamp ? new Date(b.timestamp*1000).toLocaleString() : '';
      div.innerHTML = `<strong>${b.event||'event'}</strong><br><small>${time} ‚Ä¢ Block #${b.index||'?'}</small>`;
      log.appendChild(div);
    });
  }catch(e){ document.getElementById('blockchainLog').textContent = 'Failed to load log'; }
}

/* attach event listeners (preserve function names used originally) */
document.getElementById('loginBtn').addEventListener('click', handleLogin);
document.getElementById('signupBtn').addEventListener('click', handleRegister);

/* initialize UI */
document.addEventListener('DOMContentLoaded', ()=>{
  const savedTheme = localStorage.getItem('theme') || 'dark';
  document.documentElement.setAttribute('data-theme', savedTheme);
  if(token){ try{ const sub = decodeJWT(token).sub; enterAuthMode(sub);}catch(e){ enterAuthMode(); } } else { updateUI(); }
});
</script>
</body>
</html>
